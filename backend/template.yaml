AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Meaningful Backend - Serverless application for scheduling calls with friends'

Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Deployment stage
  
  DynamoDbEndpoint:
    Type: String
    Default: ''
    Description: Optional override for DynamoDB endpoint (used for local development)
  
  GoogleClientId:
    Type: String
    Description: Google OAuth Client ID
    NoEcho: true
  
  GoogleClientSecret:
    Type: String
    Description: Google OAuth Client Secret  
    NoEcho: true
  
  FrontendUrl:
    Type: String
    Default: 'http://localhost:3000'
    Description: Frontend URL for OAuth redirects

Globals:
  Function:
    Timeout: 30
    Runtime: python3.13
    Environment:
      Variables:
        STAGE: !Ref Stage
        USERS_TABLE: !Ref UsersTable
        CALENDARS_TABLE: !Ref CalendarsTable
        CONTACTS_TABLE: !Ref ContactsTable
        FRIENDS_TABLE: !Ref FriendsTable
        GOOGLE_CLIENT_ID: !Ref GoogleClientId
        GOOGLE_CLIENT_SECRET: !Ref GoogleClientSecret
        FRONTEND_URL: !Ref FrontendUrl
        DYNAMODB_ENDPOINT: !Ref DynamoDbEndpoint
  Api:
    Cors:
      AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
      AllowHeaders: "'Content-Type,Authorization'"
      AllowOrigin: "'*'"

Resources:
  # API Gateway
  MeaningfulApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowOrigin: "'*'"

  # Lambda Functions
  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.auth.handler
      Events:
        GoogleAuth:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /auth/google
            Method: GET
        AuthCallback:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /auth/callback
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  CalendarFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.calendar.handler
      Events:
        CalendarSync:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /calendar/sync
            Method: POST
        GetEvents:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /calendar/events
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CalendarsTable

  AvailabilityFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.availability.handler
      Events:
        GetAvailability:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/availability
            Method: GET
        UpdateAvailability:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/availability
            Method: PUT
        OptionsAvailability:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/availability
            Method: OPTIONS
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  ProfileFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.profile.handler
      Events:
        GetProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/profile
            Method: GET
        UpdateProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/profile
            Method: PUT
        OptionsProfile:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/profile
            Method: OPTIONS
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  ContactsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.contacts.handler
      Events:
        ImportContacts:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/contacts/import
            Method: POST
        SearchContacts:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/contacts
            Method: GET
        OptionsContacts:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/contacts
            Method: OPTIONS
        OptionsContactsImport:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/contacts/import
            Method: OPTIONS
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ContactsTable

  FriendsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src
      Handler: handlers.friends.handler
      Events:
        ListFriends:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends
            Method: GET
        AddFriend:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends
            Method: POST
        AvailableNow:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends/available-now
            Method: GET
        RemoveFriend:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends/{friend_id}
            Method: DELETE
        OptionsFriends:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends
            Method: OPTIONS
        OptionsFriendDetail:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends/{friend_id}
            Method: OPTIONS
        OptionsFriendsAvailableNow:
          Type: Api
          Properties:
            RestApiId: !Ref MeaningfulApi
            Path: /users/{user_id}/friends/available-now
            Method: OPTIONS
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ContactsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref FriendsTable

  # DynamoDB Tables
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'meaningful-${Stage}-users'
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      BillingMode: PAY_PER_REQUEST

  CalendarsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'meaningful-${Stage}-calendars'
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: calendar_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: calendar_id
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  ContactsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'meaningful-${Stage}-contacts'
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: contact_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: contact_id
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  FriendsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub 'meaningful-${Stage}-friends'
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: friend_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: friend_id
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

Outputs:
  ApiEndpoint:
    Description: 'API Gateway endpoint URL'
    Value: !Sub 'https://${MeaningfulApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/'
    Export:
      Name: !Sub 'meaningful-${Stage}-api-url'
  
  ApiUrl:
    Description: 'API URL for OAuth redirects'
    Value: !Sub 'https://${MeaningfulApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}'
    Export:
      Name: !Sub 'meaningful-${Stage}-api-base-url'
  
  UsersTableName:
    Description: 'DynamoDB Users table name'
    Value: !Ref UsersTable
    Export:
      Name: !Sub 'meaningful-${Stage}-users-table'
  
  CalendarsTableName:
    Description: 'DynamoDB Calendars table name'
    Value: !Ref CalendarsTable
    Export:
      Name: !Sub 'meaningful-${Stage}-calendars-table'

  ContactsTableName:
    Description: 'DynamoDB Contacts table name'
    Value: !Ref ContactsTable
    Export:
      Name: !Sub 'meaningful-${Stage}-contacts-table'

  FriendsTableName:
    Description: 'DynamoDB Friends table name'
    Value: !Ref FriendsTable
    Export:
      Name: !Sub 'meaningful-${Stage}-friends-table'